<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Ansible Patch Report</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .host-card { border: 1px solid #ccc; border-radius: 8px; margin: 15px; padding: 15px; background: #f9f9f9; }
        .host-header { font-size: 20px; font-weight: bold; margin-bottom: 10px; }
        .status { padding: 4px 8px; border-radius: 5px; color: white; font-size: 12px; }
        .status.up-to-date { background: green; }
        .status.pending { background: orange; }
        .status.failed { background: red; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        table, th, td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: top; }
        th { background: #eee; }
        .search-box { margin-bottom: 20px; }
        .search-input { width: 100%; padding: 8px; font-size: 14px; border: 1px solid #ccc; border-radius: 5px; }
    </style>
    <script>
        function searchHosts() {
            let input = document.getElementById("searchInput").value.toLowerCase();
            let cards = document.getElementsByClassName("host-card");
            for (let i = 0; i < cards.length; i++) {
                let cardText = cards[i].innerText.toLowerCase();
                cards[i].style.display = cardText.includes(input) ? "" : "none";
            }
        }
    </script>
</head>
<body>
    <h1>Ansible Patch Report</h1>

    <div class="search-box">
        <input type="text" id="searchInput" class="search-input" onkeyup="searchHosts()" placeholder="Search for a host, IP, or package...">
    </div>

    {% for linux_host in groups['all'] %}
    <div class="host-card">
        <div class="host-header">
            {{ hostvars[linux_host]['ansible_hostname'] 
               | default(hostvars[linux_host]['inventory_hostname'].split('.')[0]) }}
            <span class="status up-to-date">Up-to-date</span>
        </div>
        <p><strong>Package Manager:</strong> {{ hostvars[linux_host]['ansible_pkg_mgr'] | default('N/A') }}</p>
        <p><strong>OS:</strong> {{ hostvars[linux_host]['ansible_distribution'] | default('N/A') }} {{ hostvars[linux_host]['ansible_distribution_version'] | default('') }}</p>
        <p><strong>Kernel:</strong> {{ hostvars[linux_host]['ansible_kernel'] | default('N/A') }}</p>

        <h3>Last Patch Info</h3>
        <table>
            <tr><th>IP Address</th><td>{{ hostvars[linux_host]['ansible_host'] | default('N/A') }}</td></tr>
            <tr><th>User ID</th><td>{{ hostvars[linux_host]['ansible_user'] | default('N/A') }}</td></tr>
            <tr><th>System Date</th><td>{{ hostvars[linux_host]['system_date'].stdout | default('N/A') }}</td></tr>
            <tr><th>Last Reboot Time</th><td>{{ hostvars[linux_host]['last_reboot'].stdout | default('N/A') }}</td></tr>
            <tr>
                <th>Last 15 Installed Packages</th>
                <td>
                    {% if hostvars[linux_host]['last_installed_packages'] is defined and hostvars[linux_host]['last_installed_packages'].stdout_lines %}
                        {% for pkg in hostvars[linux_host]['last_installed_packages'].stdout_lines %}
                            - {{ pkg }}<br>
                        {% endfor %}
                    {% else %}
                        No package data available
                    {% endif %}
                </td>
            </tr>
        </table>
    </div>
    {% endfor %}
</body>
</html>
